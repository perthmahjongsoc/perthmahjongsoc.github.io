#!/usr/bin/env python3

"""
# scoring.py

Generate `scores/*.cmdr` used by `scores/index.cmd`.

To be called with one positional argument (latest_date)
by `./build` in the root directory,
after mahjong-scorer generates `scores*.tsv`
but before conway-markdown generates `scores/index.html`.
"""

import re
import sys


def split(line):
    return line.strip().split('\t')


def nicify_header(header):
    return header.replace('_', ' ').title()


def nicify_data(data):
    return re.sub('^-', 'âˆ’', data)  # U+2212 MINUS SIGN


def tsv_to_cmdr(base_name, latest_date):
    with open(f'./scores/{base_name}.tsv', 'r', encoding='utf-8') as tsv_file:
        lines = tsv_file.readlines()

    head_line = lines[0]
    body_lines = lines[1:-1]
    foot_line = lines[-1]

    head_content = [
        '        //\n' + '\n'.join(f'          ; {nicify_header(header)}' for header in split(head_line))
    ]
    body_content = [
        '        //\n' + '\n'.join(f'          , {nicify_data(data)}' for data in split(body_line))
        for body_line in body_lines
    ]
    foot_content = [
        '        //\n' + '\n'.join(f'          , {nicify_data(data)}' for data in split(foot_line))
    ]

    cmdr_content = '\n'.join([
        f'# Automatically generated by `./build` in the root directory.',
        f'',
        f'OrdinaryDictionaryReplacement: #.{base_name}',
        f'- queue_position: BEFORE #divisions',
        f'* %%score-table({base_name}) -->',
        '  ||{.wide}',
        "    ''",
        '      |^',
        *head_content,
        '      |:',
        *body_content,
        '      |_',
        *foot_content,
        "    ''",
        '  ||',
        f'* %date-latest --> {latest_date}' if latest_date else '',
        '',
    ])

    with open(f'./scores/{base_name}.cmdr', 'w', encoding='utf-8')as cmdr_file:
        cmdr_file.write(cmdr_content)


def main():
    tsv_to_cmdr(base_name='2023', latest_date=None)
    tsv_to_cmdr(base_name='2024', latest_date=None)
    tsv_to_cmdr(base_name='latest', latest_date=sys.argv[1])


if __name__ == '__main__':
    main()
